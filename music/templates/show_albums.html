{% extends 'base.html' %}

{% block content %}
<h2 class="mb-4">–≤—Å–µ –∞–ª—å–±–æ–º—ã</h2>

<!-- –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ -->
<div class="btn-group mb-4" role="group">
    <a href="?source=db" class="btn btn-outline-primary {% if source == 'db' %}active{% endif %}">
        –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö sqlite
    </a>
    <a href="?source=json" class="btn btn-outline-primary {% if source == 'json' %}active{% endif %}">
        –∏–∑ json —Ñ–∞–π–ª–æ–≤
    </a>
</div>

<!-- –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ sqlite –±–∞–∑–µ -->
{% if source == 'db' %}
<div class="alert alert-info mb-4">
    <h5>–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:</h5>
    <p>–≤—Å–µ –∞–ª—å–±–æ–º—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ sqlite –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ <strong>db.sqlite3</strong></p>
    <p>—á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –º–æ–∂–Ω–æ:</p>
    <ul>
        <li>—Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª db.sqlite3 –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞</li>
        <li>–æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ sqlite (–Ω–∞–ø—Ä–∏–º–µ—Ä, DB Browser for SQLite)</li>
        <li>–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ: <code>sqlite3 db.sqlite3</code> –∑–∞—Ç–µ–º <code>SELECT * FROM music_album;</code></li>
    </ul>
</div>
{% endif %}

<!-- ajax –ø–æ–∏—Å–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö) -->
{% if source == 'db' %}
<div class="mb-4">
    <input type="text" id="searchInput" class="form-control" placeholder="–ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é...">
</div>
{% endif %}

<!-- —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ ajax -->
<div id="searchResults"></div>

<!-- –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤ -->
<div id="albumsList">
    {% if albums %}
        <div class="row">
            {% for album in albums %}
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ album.title }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">{{ album.artist }}</h6>
                        <p class="card-text">
                            –≥–æ–¥: {{ album.year }}<br>
                            –ø–µ—Å–µ–Ω: {{ album.songs }}
                        </p>
                        
                        {% if source == 'db' %}
                        <div class="btn-group">
                            <a href="{% url 'edit_album' album.id %}" class="btn btn-sm btn-outline-warning">‚úèÔ∏è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                            <a href="{% url 'delete_album' album.id %}" class="btn btn-sm btn-outline-danger">üóëÔ∏è —É–¥–∞–ª–∏—Ç—å</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">
            {% if source == 'db' %}
                –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∞–ª—å–±–æ–º–æ–≤
            {% else %}
                –Ω–µ—Ç json —Ñ–∞–π–ª–æ–≤ —Å –∞–ª—å–±–æ–º–∞–º–∏
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if source == 'db' %}
<script>
$(document).ready(function() {
    $('#searchInput').on('keyup', function() {
        var query = $(this).val();
        
        if (query.length >= 2) {
            $.ajax({
                url: '/search/',
                data: {'q': query},
                dataType: 'json',
                success: function(data) {
                    var results = $('#searchResults');
                    var albumsList = $('#albumsList');
                    
                    albumsList.hide();
                    results.empty();
                    
                    if (data.albums.length > 0) {
                        var html = '<div class="row">';
                        
                        $.each(data.albums, function(index, album) {
                            html += `
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">${album.title}</h5>
                                        <h6 class="card-subtitle mb-2 text-muted">${album.artist}</h6>
                                        <p class="card-text">
                                            –≥–æ–¥: ${album.year}<br>
                                            –ø–µ—Å–µ–Ω: ${album.songs}
                                        </p>
                                        <div class="btn-group">
                                            <a href="/edit/${album.id}/" class="btn btn-sm btn-outline-warning">‚úèÔ∏è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                                            <a href="/delete/${album.id}/" class="btn btn-sm btn-outline-danger">üóëÔ∏è —É–¥–∞–ª–∏—Ç—å</a>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        });
                        
                        html += '</div>';
                        results.html(html);
                    } else {
                        results.html('<div class="alert alert-warning">–Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>');
                    }
                }
            });
        } else {
            $('#searchResults').empty();
            $('#albumsList').show();
        }
    });
});
</script>
{% endif %}
{% endblock %}